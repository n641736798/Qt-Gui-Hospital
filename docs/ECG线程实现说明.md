# ECG心电图线程实现说明

## 概述

为了提高心电图数据处理的性能和实时性，我们实现了一个专门的ECG数据生成线程，将数据生成和UI更新分离。

## 架构设计

### 1. ECGDataThread 类
- **位置**: `include/ecgdatathread.h`, `src/ecgdatathread.cpp`
- **功能**: 专门负责生成模拟心电图数据
- **继承**: `QThread`

### 2. 主要特性

#### 线程安全
- 使用 `QMutex` 和 `QWaitCondition` 确保线程安全
- 支持启动、停止、暂停、恢复操作

#### 可配置参数
- **心率**: 40-200 BPM (默认72 BPM)
- **振幅**: 0.1-5.0 (默认1.0)
- **噪声水平**: 0.0-0.5 (默认0.05)

#### 高精度采样
- **采样率**: 500Hz
- **更新频率**: 20ms间隔
- **数据格式**: 4导联同步数据

## 实现细节

### 1. 数据结构
```cpp
struct ECGDataPoint {
    double timestamp;    // 时间戳
    double values[4];    // 4个导联的数据值
};
```

### 2. 心电波形生成
实现了医学标准的PQRST波形：
- **P波**: 心房去极化
- **QRS复合波**: 心室去极化 (Q波、R波、S波)
- **T波**: 心室复极化
- **基线**: 包含漂移和噪声

### 3. 多导联支持
- **导联I**: 标准振幅
- **导联II**: 1.2倍振幅，轻微相位偏移
- **导联III**: 0.8倍振幅
- **导联aVR**: 倒置波形 (-0.6倍振幅)

## 使用方法

### 1. 启动ECG数据生成
```cpp
ecgDataThread->startGeneration();
```

### 2. 停止ECG数据生成
```cpp
ecgDataThread->stopGeneration();
```

### 3. 调整参数
```cpp
ecgDataThread->setHeartRate(80);      // 设置心率为80 BPM
ecgDataThread->setAmplitude(1.5);     // 设置振幅为1.5
ecgDataThread->setNoiseLevel(0.1);    // 设置噪声水平为0.1
```

## 性能优化

### 1. 数据缓冲
- 每个导联维护独立的数据缓冲区
- 最大缓冲200个数据点
- 自动移除过期数据

### 2. 滚动显示
- 10秒时间窗口
- 实时更新X轴范围
- 平滑的滚动效果

### 3. 线程通信
- 使用Qt的信号槽机制
- `Qt::QueuedConnection` 确保线程安全
- 异步数据传输，不阻塞UI

## 控制按钮

- **op1Button**: 启动ECG数据生成
- **op2Button**: 停止ECG数据生成

## 技术优势

1. **分离关注点**: 数据生成与UI渲染分离
2. **高性能**: 专用线程避免UI阻塞
3. **实时性**: 500Hz采样率提供高精度数据
4. **可扩展**: 易于添加新的导联或参数
5. **医学准确性**: 符合标准心电图波形特征

## 未来扩展

1. **实际设备接入**: 可替换模拟数据为真实ECG设备数据
2. **数据存储**: 添加心电图数据的保存和回放功能
3. **分析算法**: 集成心率变异性、心律不齐检测等算法
4. **多患者支持**: 支持同时监控多个患者的心电图

## 注意事项

- 线程在应用程序退出时会自动停止
- 所有参数都有合理的范围限制
- 使用前确保已正确初始化UI组件